<html>

<head>
    <title>AUCTCHAIN</title>
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <!-- <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script> -->
    <script src="js/bootstrap.min.js"></script>
    <style>
        ::-webkit-scrollbar {
            width: 0 !important;
        }
    </style>
</head>

<body>
    <nav class="navbar sticky-top navbar-dark bg-dark">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item">
                <a class="h3" style="color:white">
                    Hello, <small id="out_show_user">Anonymous</small>
                </a>
            </li>
            <li class="nav-item">
                <a class="h5" style="color:white">
                    You have, <small id="out_show_balance">unknown</small> ETH balance.
                </a>
            </li>
        </ul>

    </nav>
    <div class="container-fluid">
        <form class="col-md-3" id="form_regist" style="display: inherit; margin-top: 25px; border-radius: 5px;">
            <div class="form-group">
                <label>Username</label>
                <input type="text" class="form-control" id="in_reg_name" placeholder="Enter your name">
            </div>
            <div class="form-group">
                <label>Email address</label>
                <input type="email" class="form-control" id="in_reg_email" aria-describedby="emailHelp" placeholder="Enter your email">
                <small id="emailHelp" class="form-text text-muted">We'll never share your email with anyone else.</small>
            </div>
            <div class="form-group">
                <label>Contact</label>
                <input type="text" class="form-control" id="in_reg_contact" placeholder="Enter your contact">
            </div>
            <button type="submit" id="btn_regist" class="btn btn-primary">Submit</button>
        </form>
    </div>

    <div class="container">
        <table id="table_historyBid" class="table table-hover table-nd">
            <caption>Bid List</caption>
            <thead class="thead-dark">
                <tr>
                    <th>Timestamp</th>
                    <th>Bidder</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                <!-- History Goes Here -->
            </tbody>
        </table>
    </div>
    <script src="js/web3.min.js"></script>
    <script src="js/requirement.js"></script>
    <script>
        // Refresh hack
        // window.onreset = () => {
        //     window.location.reload();
        // }
        // Membuat variable global untuk menampung account address
        let accountAddress = null;

        window.addEventListener('load', () => {

            // Load Web3 Support
            web3 = new Web3(window.web3.currentProvider);
            if (typeof window.web3 !== 'undefined' && typeof window.web3.currentProvider !== 'undefined')
                web3.eth.setProvider(window.web3.currentProvider);
            else
                web3.eth.setProvider(provider); // set to TestRPC if not available

            var auctionInterval = setInterval(function updateAuctionHTML() {

                queryUser = document.querySelector('#out_show_user');
                queryBalance = document.querySelector('#out_show_balance');
                web3.eth.getAccounts().then(accounts => {
                    accountAddress = accounts[0];
                    web3.eth.getBalance(accounts[0]).then(res => {
                        queryBalance.innerHTML = web3.utils.fromWei(res, 'ether');
                    });
                });

                AuctionHouse = getContract();

                queryStatus = document.querySelector('#out_reg_status');
                AuctionHouse.methods.isRegistered(accountAddress).call().then(res => {
                    if (res) {
                        AuctionHouse.methods.getRegisteredData(accountAddress).call().then(reg => {
                            queryUser.innerHTML = reg[0] + ' // ' + reg[1] + ' // ' +
                                reg[2];
                        });
                        document.querySelector('#form_regist').style.display = 'none';
                    } else {
                        queryUser.innerHTML = accountAddress;
                        document.querySelector('#form_regist').style.display = 'inherit';
                    }
                });

                AuctionHouse.methods.getAuctionsCountForUser(accountAddress).call().then(length => {
                    for (i = 0; i < length; i++) {
                        AuctionHouse.methods.getAuctionIdForUserAndIdx(accountAddress, i).call()
                            .then(res => {

                            });
                    }
                });




                // Auction.methods.getHighestBid().call().then(res => {
                //     highestBid.innerHTML = web3.utils.fromWei(res, 'ether');
                // });

                // Auction.methods.getBeneficiary().call().then(res => {
                //     if (res == accountAddress) {
                //         beneficiaryAddr.innerHTML = 'You are beneficiary';
                //         document.querySelector('#auction-form').style.display = 'none';
                //     } else {
                //         beneficiaryAddr.innerHTML = res.substr(0, 16);
                //         document.querySelector('#auction-form').style.display = 'flex';
                //     }
                // });
            }, 1);

            const registEvent = document.querySelector('#btn_regist');
            registEvent.addEventListener('click', () => {
                const name = document.querySelector("#in_reg_name").value;
                const email = document.querySelector("#in_reg_email").value;
                const contact = document.querySelector("#in_reg_contact").value;

                AuctionHouse.methods.register(name, email, contact).send({
                    from: accountAddress
                });
            });

            // // seleksi input dan button
            // const bidVal = document.querySelector('#bid-value');
            // const bidBtn = document.querySelector('#bid-btn');

            // // menambahkan listener click pada button donate
            // bidBtn.addEventListener('click', () => {
            //     // mengambil value jumlah ether yang akan didonasikan dalam string
            //     const nama = document.querySelector("#nama-bidder").value;
            //     const email = document.querySelector("#email-bidder").value;
            //     const telepon = document.querySelector("#telepon-bidder").value;
            //     const bidValue = bidVal.value;

            //     Auction.methods.bid().send({
            //         value: web3.utils.toWei(bidValue, 'ether'),
            //         from: accountAddress
            //     });
            // });
            /* Event Regist */
            // const registEvent = document.querySelector('#bid-btn');

        });
    </script>
    <script>
        function myCreateFunction() {
            var table = document.getElementById("table_historyBid");
            var row = table.insertRow(0);
            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);
            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);
            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);
            cell1.innerHTML = "NEW CELL1";
            cell2.innerHTML = "NEW CELL2";
        }
    </script>
</body>

</html>